# 摊还分析

??? abstract "重点"
    - 平摊分析方法的作用和三种平摊分析方法各自特点；
    - 聚集分析法及应用；
    - 记账分析法及应用；
    - 势能法及应用。

## 基本思想

摊还分析的目标是求解**数据结构**的一个**操作序列**中所执行的所有操作的平均时间，来评价操作的**代价**。与算法时间复杂度中的平均时间复杂度不同，这个平均代价与输入数据的分布无关，不是一个概率性的代价，而是用来衡量数据结构的操作性能的。

## 适用案例

在讨论具体的分析方法之前，先给出两个具体的问题。

!!! question "栈的操作序列"
    考虑一个栈数据结构，可在上面执行三种操作，分别为压栈、弹出和连续弹出。

    === "压栈"
    
        ```python linenums="1"
        def Push(s, element):
            s.append(element)
        ```
        

    === "出栈"

        ```python linenums="1"
        def Pop(s):
            return s[-1]
        ```

    === "连续弹出"

        ```python linenums="1"
        def MultiPop(s, k):
            while not Empty(s) and k > 0:
                Pop(s)
                k = k - 1
        ```
    
    有一个包含若干个上述操作的序列，操作总数为 $n$，目标是分析该序列的总代价的上界或每个操作的平均代价。

上述问题中，栈操作的代价可以很容易得出，即压栈、弹出和连续弹出的代价分别为 $O(1)$、$O(1)$ 和 $\min\{O(s), O(k)\}$，其中 $s$ 为栈的容量。

!!! question "二进制计数器递增"
    考虑一个二进制计数器，计数器的初值为 $0$，用一个位数组 `A[0...k - 1]` 作为数据结构。数组的每个元素 `A[i]` 为 $0$ 或 $1$，表示计数器内存储的数的二进制序列的第 $i$ 位。具体地，若计数器的值为 $x$，则有

    $$
    x = \sum_{i = 0}^{k - 1} A[i] \times 2^i
    $$

    计数器仅支持一个操作即为递增操作。

    ```python title="计数器递增" linenums="1"
    def Increment(A):
        i = 0
        while i < len(A) and A[i] == 1:
            A[i] = 0
            i = i + 1
        if i < len(A):
            A[i] = 1
    ```

    目标是分析对计数器做 $n$ 次递增操作的总代价的上界或每次操作的平均代价。

上述问题中，操作 `Increment` 的代价与翻转的位数呈线性关系。

## 聚合分析

聚合分析用来确定一个 $n$ 个操作序列的**总代价的上界** $T(n)$。因而每个操作的平均代价为 $T(n) / n$，作为每个操作的**摊还代价**。显然利用聚合分析得到的每个操作的摊还代价都是**相等**的。

### 栈操作

考虑一个由 $n$ 个 `Push`、`Pop` 和 `MultiPop` 组成的序列在空栈上执行。一个重要的观察是序列中 `Pop` 的数量（包括 `MultiPop` 中调用的）最多和 `Push` 操作的数量相同，因为**一个元素只能被弹出一次**。设栈的容量为 $n$，则序列的总代价最多为 $O(n)$，从而每个操作的摊还代价为 $O(n) / n = O(1)$。

### 二进制计数器

在二进制计数器问题中，每次调用 `Increment` 操作，`A[0]` 都会被翻转一次，而 `A[1]` 没两次调用才翻转一次，`A[2]` 每四次调用翻转一次…… 从而对于一个初值为 $0$ 的计数器，每 $n$ 次 `Increment` 操作翻转的位数为

$$
\sum_{i = 0}^{k - 1} \lfloor \frac{n}{2^i} \rfloor < n \sum_{i = 0}^{\infty} \frac{1}{2^i} = 2n
$$

因此序列的总代价为 $O(n)$，`Increment` 的摊还代价为 $O(n) / n = O(1)$。

